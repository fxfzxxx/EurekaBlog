---
title: Java 复习之视频通信小项目
description: 通过 Java 实现的一格视频通信软件
authors:
  - Aaron
tags:
  - All
categories:
  - Technology
  - Projects
series:
  - 前端项目展示
tags:
  - 项目
date: '2022-01-17'
lastmod: '2022-01-17'
featuredImage: images/java-logo.png
toc: true
draft: false
---



## 视频通信

### 建立 TCP 连接

- 服务端需要有一个 `ServerSocket` 对象, 通过他的 `accept` 方法监听客户端的 `socket` 请求并且返回一个`socket`来与客户端的 `socket` 建立连接.

### 发信息

#### 最基础的写法

- 服务端

```java
Socket socket = serverSocket.accept();
OutputStream ous = serverSocket.getOutputStream();
String msg = "hello \r\n";
byte[] data = msg.getBytes();
ous.write(data);
```

这个基础的写法目前还只是用于了解发送的 基本原理, 没有继续研究如何发送中文.

- 发信息的一方需要有一个输出流对象 `OutputStream` , 可以通过 `Socket` 对象的 `getOutputStream` 方法返回.

- 创建一个 `String` 对象存储所发的消息

- 使用 `getByte` 方法将字符创存入一个 `Byte` 型的数组.

  - 查了源码后发现, String 类有一个静态的 `value` 属性, 是一个 `byte` 类型的数组, 字符串的每个字符都相应存在数组里面. 通过在 SringUTF16 的类里面如下方法

  - ```java
    public static byte[] toBytes(char[] value, int off, int len) {
            byte[] val = newBytesFor(len);
            for (int i = 0; i < len; i++) {
              // 3个参数依次是 byte[],int,int
                putChar(val, i, value[off]);
                off++;
            }
            return val;
        }
    ```

  - 这里实际上是把 `char` 数组里面的 `char` 直接通过 `int c` 传入到以下方法

  - **因为 `char` 实际上存储的是一个整数: 0~65535(2^16), 是字符在字符编码表中的位置.**

  - 我经过测试发现实际上 `char` 字符可以直接转换成 `int` 变量. 输出的话会得到对应的 ASCII 码.

    ```java
     static void putChar(byte[] val, int index, int c) {
            assert index >= 0 && index < length(val) : "Trusted caller missed bounds check";
            index <<= 1;
       // 这里证实是相邻的两个byte位置存储了一个 char 类型
            val[index++] = (byte)(c >> HI_BYTE_SHIFT);
            val[index]   = (byte)(c >> LO_BYTE_SHIFT);
        }
    ```

- 用输出流对象 ` OutputStream` 的 `write` 方法把 `byte` 数组传进去

  - 所有的输入输出流都是基于字节的.



#### 简化版写法

- 服务端

```java
Socket socket = serverSocket.accept();
DataOutputStream out = new DataOutputStream(serverSocket.getOutputStream);
out.writeUTF("这里可以直接写中文");
```

### 收信息

#### 最基础的写法

- 客户端

```java
Socket socket = new Socket("localhost", 50000);
InputStream in = socket.getInputStream();
int readMsg = 0;
while(true) {
  readMsg = in.read()// 这里有的 read 每次读取一个字节, 所以得到的取值范围是 0~255 的 ASC 码
  if(readMsg == -1) break; //意思是读到末尾了
  }
	System.out.println((char)readMsg);
}
```

#### 简单写法

```java
Socket socket = new Socket("localhost", 50000);
DataInputStream in = new DataInputSteam(socket.getInputStream);
Sting inMsg = in.readUTF();
```

